# 实施计划：智能报销排版工具 (EasyInvoice)

**文档版本**: V1.0.0
**策略**: UI 优先，逐步集成逻辑
**技术栈**: React + Vite + Tailwind CSS + Zustand + IndexedDB

---

## 第一阶段：项目初始化与基础设施 (Phase 1: Infrastructure)

本阶段目标是建立稳固的代码库基础，配置所有必要的工具链，并确保开发环境就绪。

- [x] **Task-100: 项目脚手架搭建**
    - **依赖**: 无
    - **上下文**: 使用 Vite 初始化 React + TypeScript 项目，配置 Tailwind CSS 和路径别名，确保项目结构符合 Feature-based 架构。
    - **子任务**:
        - [x] 100.1: 使用 `npm create vite@latest` 初始化项目（React + TypeScript）。
        - [x] 100.2: 安装并初始化 Tailwind CSS 和 PostCSS。
        - [x] 100.3: 配置 `tsconfig.json` 中的路径别名（例如 `@/components`, `@/features`）。
        - [x] 100.4: 创建 `src/features`, `src/components`, `src/store`, `src/lib` 等目录结构。
        - [x] 100.5: 安装基础依赖：`zustand`, `clsx`, `tailwind-merge`。
        - [x] 100.6: **验证**: 运行 `npm run dev`，确认应用能启动，且 Tailwind 样式（如 `bg-red-500`）生效。

- [x] Task-101: UI 组件库集成 <!-- id: 101 -->
    - [x] 101.1: 初始化 shadcn/ui CLI (使用手动集成模式) <!-- id: 101.1 -->
    - [x] 101.2: 添加基础组件：`Button` (按钮)。 <!-- id: 101.2 -->
    - [x] 101.3: 添加基础组件：`Input` (输入框)。 <!-- id: 101.3 -->
    - [x] 101.4: 添加基础组件：`Dialog` / `Modal` (模态框)。 <!-- id: 101.4 -->
    - [x] 101.5: 添加基础组件：`Card` (卡片，用于文件展示)。 <!-- id: 101.5 -->
    - [x] 101.6: 添加基础组件：`ScrollArea` (滚动区域)。 <!-- id: 101.6 -->
    - [x] 101.7: **验证**: 创建一个临时的 `TestComponents.tsx` 页面，展示所有上述组件，确保样式和交互正常。 <!-- id: 101.7 -->

- [x] Task-102: 状态管理与存储层配置 <!-- id: 102 -->
    - [x] 102.1: 安装 `idb-keyval`。 <!-- id: 102.1 -->
    - [x] 102.2: 创建 `src/lib/db.ts`，封装简单的 `get`, `set`, `del` 方法。 <!-- id: 102.2 -->
    - [x] 102.3: 创建空的 Zustand store `useAppStore`，并在其中集成 `persist` 中间件（连接 idb-keyval）。 <!-- id: 102.3 -->
    - [x] 102.4: **验证**: 在控制台调用 store 的写入方法，刷新页面后确认数据能从 IndexedDB 恢复。 <!-- id: 102.4 -->

---

## 第二阶段：静态 UI 布局 (Phase 2: Static UI Layout)

本阶段目标是完成所有页面的视觉结构，暂不包含复杂的业务逻辑（如拖拽、计算）。重点是布局的响应式和 A4 纸张的精确渲染。

- [x] **Task-200: 全局应用布局 (App Layout)**
    - **依赖**: Task-101
    - **上下文**: 实现 IDE 风格的三栏布局：左侧资源栏、中间工作区、右侧属性栏。
    - **子任务**:
        - [x] 200.1: 创建 `Layout` 组件，使用 Flexbox 实现左(250px)-中(自适应)-右(300px)结构。
        - [x] 200.2: 实现左侧 Sidebar 容器样式（背景色、边框）。
        - [x] 200.3: 实现中间 Workspace 容器样式（深灰色背景、居中对齐）。
        - [x] 200.4: 实现右侧 Properties 面板容器样式。
        - [x] 200.5: **验证**: 在不同屏幕尺寸下，中间区域能自适应缩放，左右侧边栏宽度固定。

- [x] **Task-201: 中间 A4 画布 UI**
    - **依赖**: Task-200
    - **上下文**: 在工作区绘制物理尺寸精确的 A4 纸张，并绘制可视化的辅助网格线。
    - **子任务**:
        - [x] 201.1: 创建 `GridCanvas` 组件。
        - [x] 201.2: 使用 CSS 设置固定尺寸 `210mm x 297mm`，并添加白色背景和阴影。
        - [x] 201.3: 使用 CSS Grid 或 SVG 绘制 4列 x 6行 的辅助虚线网格。
        - [x] 201.4: 确保 A4 画布在父容器中居中显示。
        - [x] 201.5: **Auto-Fit**: 实现画布自动缩放逻辑，确保在任意窗口大小下完整显示整页 A4 (无滚动条)。
        - [x] 201.6: **验证**: 使用浏览器开发者工具测量 DOM 元素的像素尺寸，确保比例约为 1:1.414。

- [x] **Task-202: 核心组件 UI - 付款凭单 (Payment Voucher)**
    - **依赖**: Task-201
    - **上下文**: 实现固定在 A4 顶部的付款凭单静态样式。
    - **子任务**:
        - [x] 202.1: 创建 `Voucher` 组件。
        - [x] 202.2: 实现顶部标题“付款凭单”和基本信息（报销人、日期）的输入框布局。
        - [x] 202.3: 实现中间金额汇总区（用途摘要、总金额、大写金额）的静态展示样式。
        - [x] 202.4: 实现底部签字区（财务、审批等标签）的布局。
        - [x] 202.5: **验证**: 将组件放入 A4 画布顶部，确认其占用空间符合设计（约占顶部 1/3）。

- [x] **Task-204: 工作区缩放控制 (Workspace Zoom)**
    - **依赖**: Task-201
    - **上下文**: 在工作区右下角添加缩放滑块，支持手动缩放查看细节，不影响导出。
    - **子任务**:
        - [x] 204.1: 重构 `useAutoFit` 为 `useZoom`，支持 Auto/Manual 模式切换。
        - [x] 204.2: 创建 `ZoomControls` 组件 (Slider + Reset 按钮)。
        - [x] 204.3: 集成到 `App.tsx` 或 `Layout` 中，悬浮于右下角。
        - [x] 204.4: **验证**: 拖动滑块能缩放画布，点击“重置”或“适应”能恢复自适应。

- [x] **Task-203: 核心组件 UI - 文件单元 (File Item)**
    - **依赖**: Task-201
    - **上下文**: 实现单个发票/截图在网格中的卡片样式，包含图片区和输入区。
    - **子任务**:
        - [x] 203.1: 创建 `FileItem` 组件。
        - [x] 203.2: 布局图片区域，设置默认占位图，样式为 `object-contain`。
        - [x] 203.3: 布局下方输入区域：用途(Input)、金额(Input)、备注(Input)。
        - [x] 203.4: 实现“选中”状态的样式（高亮边框）。
        - [x] 203.5: **验证**: 在 A4 画布中硬编码放置几个不同尺寸（2x2, 2x4）的 FileItem，检查排列是否整齐。

---

## 第三阶段：核心业务逻辑 (Phase 3: Core Logic & Interactivity)

本阶段将静态 UI 转化为动态应用，实现文件上传、网格算法、拖拽排序等核心功能。

- [x] **Task-300: 文件上传与数据模型**
    - **依赖**: Task-102, Task-200
    - **上下文**: 实现左侧 Sidebar 的上传功能，处理文件读取、压缩，并存入 Zustand Store。
    - **子任务**:
        - [x] 300.1: 定义 `ReimburseItem` TypeScript 接口 (Using `InvoiceItem`).
        - [x] 300.2: 在左侧栏实现文件拖拽上传区域 (Dropzone).
        - [x] 300.3: 实现图片读取逻辑：File -> Base64.
        - [x] 300.4: **关键**: 实现图片压缩逻辑（Canvas 绘制，限制 max-width 1500px）.
        - [x] 300.5: 更新 Store，实现 `addFiles` action (Using `addItems`).
        - [x] 300.6: **验证**: 上传 5 张大图，检查 Store 中是否生成了压缩后的数据对象，且左侧列表能显示缩略图.
    - [x] **Task-304: PDF 格式支持 (New Request)**
        - **上下文**: 用户需要上传 PDF 文件（例如电子发票）。需将 PDF 每一页转换为图片处理。
        - **子任务**:
            - [x] 304.1: 安装 `pdfjs-dist`.
            - [x] 304.2: 实现 `processPdf` 工具函数（PDF Page -> Canvas -> Base64）.
            - [x] 304.3: 更新 `UploadZone` 支持 `.pdf` 并调用新的处理逻辑.
            - [x] 304.4: **验证**: 上传多页 PDF，列表应展示多个对应的图片 Item.

- [ ] **Task-305: 发票模式与分流逻辑 (Invoice Mode & Routing)**
    - **依赖**: Task-301
    - **上下文**: 实现“核心业务流程”中的分流功能，支持发票模式的专用排版（竖向 1x2 或 横向 2x2）。
    - **子任务**:
        - [ ] 305.1: Store 添加 `appMode` 状态 ('payment' | 'invoice') 及切换 Action。
        - [ ] 305.2: 左侧栏增加模式切换 Tab (或上传时的分流引导)。
        - [ ] 305.3: 更新 `grid-layout.ts`：新增发票模式布局算法（忽略 Dense Packing，强制固定网格）。
        - [ ] 305.4: 实现发票模式下的“竖向/横向”排版切换选项。
        - [ ] 305.5: **验证**: 切换到发票模式，上传 4 张图，应自动铺满 A4（2x2）；切换为竖向，应变为 2 页（每页 2 张）。

- [x] **Task-301: 网格计算引擎 (Grid Engine)**
    - **依赖**: Task-300
    - **上下文**: 实现核心的布局算法，将文件列表转换为 A4 网格上的坐标。
    - **子任务**:
        - [x] 301.1: 创建 `useGridLayout` hook.
        - [x] 301.2: **核心**: 实现 **Dense Packing (自动填坑)** 算法：遍历 items，为每个 item 寻找网格中**第一个**能容纳它的空闲位置（即 visuals order != DOM order）.
        - [x] 301.3: 集成“垂直堆叠”强校验逻辑——当检测到目标位置右侧剩余空间不足时，强制限制 item 宽度规格.
        - [x] 301.4: 实现自动分页逻辑：当当前页排满时，坐标自动计算到下一页.
        - [x] 301.5: **验证**: 编写单元测试，输入一组混合尺寸的 items，断言其计算出的坐标无重叠且符合堆叠规则.

- [x] **Task-302: 双向拖拽实现 (Drag & Drop)**
    - **依赖**: Task-300, Task-301
    - **上下文**: 集成 `dnd-kit`，实现左侧列表和中间网格的拖拽排序。
    - **子任务**:
        - [x] 302.1: 在左侧列表集成 `SortableContext`.
        - [x] 302.2: 在中间画布集成 `SortableContext` (基于计算出的坐标渲染).
        - [x] 302.3: 实现 `onDragEnd` 处理函数：调用 Store 的 `reorderFiles` 方法.
        - [x] 302.4: 确保左侧拖拽能实时更新中间网格的排序.
        - [x] 302.5: **验证**: 拖动左侧第 1 个文件到第 3 位，中间画布对应的图片位置应同步变化.

- [x] **Task-303: 数据录入与凭单联动**
  - **依赖**: Task-202, Task-300
  - **上下文**: 实现输入框的数据绑定，以及凭单组件的自动汇总逻辑。
  - **子任务**:
    - [x] 303.1: 绑定 FileItem 的 Input (`onChange`) 到 Store 的 `updateFile` action。
    - [x] 303.2: 引入 `decimal.js`，在 Store 中实现 `totalAmount` 的计算 selector。
    - [x] 303.3: 实现 `digitUppercase` 工具函数（人民币大写转换）。
    - [x] 303.4: 实现用途摘要的自动拼接逻辑。
    - [x] 303.5: 实现摘要的 Dirty State 逻辑：手动修改后停止自动更新。
    - [x] 303.6: **验证**: 修改任意文件的金额，凭单上的总金额和大写金额应实时正确更新。

---

## 第四阶段：高级功能与完善 (Phase 4: Advanced Features)

本阶段完善用户体验，添加图片编辑、右侧属性面板控制及导出功能。

- [ ] **Task-400: 右侧属性面板交互**
    - **依赖**: Task-200, Task-300
    - **上下文**: 当选中某个文件时，右侧面板显示对应的操作选项。
    - **子任务**:
        - [ ] 400.1: 在 Store 中增加 `selectedId` 状态。
        - [ ] 400.2: 点击画布中的 FileItem 更新 `selectedId`。
        - [ ] 400.3: 在右侧面板实现“尺寸切换”按钮组 (2x2, 2x4, 4x4)。
        - [ ] 400.4: 绑定按钮点击事件到 Store 的 `resizeFile` action。
        - [ ] 400.5: **验证**: 选中一个文件，点击“2x4”，画布上的该文件应变大，且后续文件自动重排。

- [ ] **Task-401: 图片编辑 (裁剪与旋转)**
    - **依赖**: Task-400
    - **上下文**: 实现模态框内的图片裁剪功能。
    - **子任务**:
        - [ ] 401.1: 集成 `react-cropper`。
        - [ ] 401.2: 创建 `ImageEditorModal` 组件。
        - [ ] 401.3: 实现旋转功能（每次旋转 90 度）。
        - [ ] 401.4: 实现裁剪保存逻辑：将裁剪后的 Canvas 导出为新的 Base64 替换原图数据。
        - [ ] 401.5: **验证**: 上传一张图，进行裁剪并保存，画布上应显示裁剪后的版本。

- [ ] **Task-402: 导出 PDF**
    - **依赖**: Task-201, Task-301
    - **上下文**: 实现核心的导出功能，确保所见即所得。
    - **子任务**:
        - [ ] 402.1: 创建 `useExportPdf` hook。
        - [ ] 402.2: 实现 DOM 锁定逻辑：通过 ID 获取 A4 容器元素。
        - [ ] 402.3: 配置 `html2canvas`：设置 `scale: 3` (300 DPI)，处理 `useCORS` 等选项。
        - [ ] 402.4: 集成 `jspdf`：将生成的 Canvas 图片按 A4 尺寸添加到 PDF 页面中。
        - [ ] 402.5: 处理多页导出：如果有多个 A4 页面，需循环处理。
        - [ ] 402.6: **验证**: 点击导出，下载 PDF，打印或缩放查看，确保文字清晰且无 UI 杂质。

- [ ] **Task-403: 数据持久化与恢复测试**
    - **依赖**: Task-102, Task-300
    - **上下文**: 确保 IndexedDB 的读写逻辑在复杂数据下依然稳健。
    - **子任务**:
        - [ ] 403.1: 编写一个集成测试脚本/流程：上传图片 -> 修改布局 -> 关闭标签页 -> 重新打开。
        - [ ] 403.2: 验证 Store 是否正确从 `idb-keyval` 恢复了所有状态（包括图片、文字、Dirty 标记）。
        - [ ] 403.3: 添加 UI 提示：“数据已自动保存”。

---

## 第五阶段：清理与发布 (Phase 5: Polish & Ship)

- [ ] **Task-500: UI 细节打磨**
    - **依赖**: 所有前置任务
    - **上下文**: 统一 UI 风格，处理空状态和加载状态。
    - **子任务**:
        - [ ] 500.1: 添加 Empty State：当没有文件时，中间画布显示引导提示。
        - [ ] 500.2: 添加 Loading State：导出 PDF 时显示全屏遮罩/进度条。
        - [ ] 500.3: 检查所有 Input 的 Tab 键顺序，确保录入流畅。

- [ ] **Task-501: 构建与部署**
    - **依赖**: 所有前置任务
    - **上下文**: 优化构建配置，准备发布。
    - **子任务**:
        - [ ] 501.1: 运行 `npm run build`，检查是否有 TypeScript 错误。
        - [ ] 501.2: 检查构建产物 (`dist/`) 大小。
        - [ ] 501.3: 部署到 Vercel/Netlify 进行最终环境测试。