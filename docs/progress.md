# 项目进度

## 状态

- [x] 阶段 0：需求分析与设计
- [x] 阶段 1：基础设施与项目设置
- [x] 阶段 2：静态 UI 布局
- [x] 阶段 3：核心逻辑（网格引擎与状态）
- [x] 阶段 3.5：多工作区架构重构
- [x] 阶段 4：高级功能（编辑器、导出）
- [x] 阶段 5：打磨与发布

## 阶段 1：基础设施与项目设置 (已完成)

- **状态**: 已完成
- **完成日期**: 2026-02-02
- **主要成就**:
  - [x] **Task-100: 项目初始化** (2026-02-02)
    - 完成 Vite + React + TS 脚手架
    - 集成 Tailwind CSS (v3.4.17)
    - 配置项目目录架构与路径别名 `@/*`
    - 集成核心库: Zustand, clsx, lucide-react, idb-keyval

  - [x] **Task-101: UI 组件库集成** (2026-02-02)
    - 配置 `Interstellar Blue` 主题色与 CSS 变量
    - 手动封装 shadcn/ui 核心组件: `Button`, `Input`, `Label`, `Card`, `Dialog`, `ScrollArea`
    - 集成 `tailwindcss-animate` 与 Radix UI Primitives
    - 创建 `src/features/debug/TestComponents.tsx` 进行可视化验收

  - [x] **Task-102: 状态管理与存储层配置** (2026-02-02)
    - 定义 `InvoiceItem` 和 `AppSettings` 核心类型接口
    - 封装 `idbStorage` 适配器 (连接 `idb-keyval`)
    - 实现 `useInvoiceStore` (发票项) 和 `useSettingsStore` (全局设置)
    - 验证：刷新页面后，新增的 Mock Item 和设置修改均能自动恢复 配置了严格的 TypeScript 路径别名 (`@/*`)。
    - 建立了核心目录结构并安装了基础库 (`zustand`, `idb-keyval`)。
    - 验证了构建流程和基本的 Tailwind 渲染。

## 阶段 2：核心组件与布局引擎 (已完成)

- **状态**: 已完成
- **完成日期**: 2026-02-02
- **主要成就**:
  - [x] **Task-200: 全局应用布局** (2026-02-02)
    - 实现了 IDE 风格的三栏布局：Sidebar (280px), Workspace (Flex), Properties (300px)。
    - 使用 Tailwind CSS 完成基础样式和响应式容器。
  - [x] **Task-201: A4 Canvas UI & Auto-Fit** (2026-02-02)
    - 创建了标准的 210mm x 297mm A4 画布组件。
    - 实现了 4x6 辅助网格。
  - [x] **Task-202: 核心组件 UI - 付款凭单** (2026-02-02)
    - 实现了 `Voucher` 组件，包含标题、信息录入、金额汇总（静态）、签字区。
    - 实现了数据与 Zustand Store 的双向绑定，支持 IndexedDB 自动持久化。
    - 验证了数据录入后的页面刷新保留功能。
  - [x] **Task-203: 核心组件 UI - 文件单元 (File Item)** (2026-02-02)
    - 创建了 `FileItem` 组件，支持图片预览（object-contain）。
    - 集成了输入字段：金额 (Number)、类别 (Text)、日期 (Date)。
    - 实现了选中状态（蓝色光环）与悬停操作（删除/旋转）。
    - 验证了在 A4 画布中的渲染与交互。

## 阶段 3：核心功能与逻辑 (已完成)

- **状态**: 已完成
- **完成日期**: 2026-02-02
- **主要成就**:
  - [x] **Task-300: 文件上传与数据模型** (2026-02-02)
    - 实现了 `react-dropzone` 文件拖拽上传区域。
    - 实现了图片前端压缩逻辑 (Max 1500px, Client-side Canvas)。
    - 更新了 Zustand Store 支持批量添加文件 (`addItems`)。
    - 创建了左侧 Sidebar 的文件列表组件 `UploadedFileList`。
  - [x] **Task-304: PDF 格式支持** (2026-02-02)
    - 集成 `pdfjs-dist` 实现 PDF 多页转图片功能。
    - 更新 `UploadZone` 支持上传 PDF，自动提取所有页面为独立图片。
    - 验证了 PDF 与 图片混合上传的场景。
  - [x] **Task-301: 网格计算引擎 (Grid Engine)** (2026-02-02)
    - 实现了 `calculateLayout` 核心算法 (Dense Packing, 4x6 Grid)。
    - 实现了 `useGridLayout` Hook 连接 Store。
    - 重构了 `GridCanvas` 支持多页渲染 (Pagination)。
    - 实现了 Page 1 顶部区域的 Voucher 避让逻辑。
  - [x] **Task-301.1: 凭单渲染优化** (2026-02-03)
    - [x] 修复了 PDF 导出渲染问题（凭单边框重叠）。
    - [x] 优化了凭单布局间距（内边距、字体大小、行高）。
    - [x] 实现了“纯净导出”，确保网格线和页码在 PDF 中隐藏。
    - [x] 实现了“金额/用途”字段的条件可见性（如果为空则在导出时隐藏）。
    - [x] 实现了图片旋转功能（90度步进）。
    - [x] 验证了布局引擎与 PDF 预览。
    - [x] 精修凭单布局（标题居中、更大的重置按钮、修复导出边框）。
  - [x] **Task-302: 双向拖拽实现 (Drag & Drop)** (2026-02-02)
    - 集成 `dnd-kit` 实现全应用拖拽上下文。
    - 实现了 Sidebar `UploadedFileList` 的列表排序。
    - 实现了 `GridCanvas` 的网格项拖拽（基于列表顺序重排）。
    - 验证了修改 Item 顺序触发自动布局重新计算的流程。
  - [x] **Task-537: 体验优化与逻辑修复** (2026-02-02)
    - 修复工作区移除文件逻辑：移除时保留 Sidebar 条目但清空数据（金额、用途）。
    - 优化自动摘要：修复了用途修改后凭单摘要不更新的问题。
    - UI 细节：缩小凭单号间距，缩短报销人下划线，默认缩放调整为 85%。
    - 侧边栏：区分“移出工作区”与“永久删除”操作。
  - [x] **Task-205: 应用模式切换 (Invoice Mode)** (2026-02-02)
    - 实现了 `AppMode` 状态管理 (Payment / Invoice) 及持久化。
    - 实现了 Invoice Mode 下特殊的布局策略：田字格 (Cross 2x2) 和 上下分栏 (Vertical 1x2)。
    - 实现了 Header 区域的模式切换与布局选择 UI。
    - 验证了 Voucher 组件在 Invoice Mode 下的自动隐藏逻辑。
    - 验证了布局切换时的即时重排效果。

## 阶段 3.5：多工作区架构重构 (进行中)

- **状态**: 进行中
- **开始日期**: 2026-02-02
- **主要成就**:
  - [x] **Task-600: 数据模型与迁移** (2026-02-02)
    - 即将 `InvoiceItem.isOnCanvas` 替换为 `workspaceId: 'payment' | 'invoice' | null`。
    - 实现了 `useInvoiceStore` 中的数据迁移逻辑 (v0 -> v1)。
    - 更新了 `setWorkspace` Action，支持文件在不同工作区之间的流转。
    - **Global Aggregation**: 实现了 Payment Voucher 的全局数据汇总，无论文件在哪个工作区，只要被分配，其金额和用途都会被汇总。
    - 创建了 `getPaymentItems`, `getInvoiceItems`, `getAllAssignedItems` 选择器。

  - [x] **Task-601: 侧边栏多选与分流** (2026-02-02)
    - 实现了侧边栏文件的多选 (Multi-select) 机制。
    - 重构了文件列表项，增加了 Checkbox 和 P/I 归属角标。
  - [x] **Task-602: 画布项移动交互** (2026-02-02)
    - 在 Canvas 的 `FileItem` 工具栏中新增了 "Move" 按钮，根据当前模式智能显示“移至发票”或“移至凭单”。
    - 实现了在画布上直接通过点击按钮，快速将文件切换到另一个工作区的交互逻辑。
    - 验证了操作的即时反馈：点击移动后，文件立即从当前画布消失，切换 Mode 后可见。
  
  - [x] **Task-603: 导出与打印优化** (2026-02-03)
    - 实现了 PDF 导出功能，支持多页生成。
    - 修复了发票布局方向问题：田字格自动横向 (Landscape)，上下分栏保持纵向 (Portrait)。
    - 解决了画布内容裁剪问题，优化了滚动容器。
    - 实现了导出预览窗口 (PDF Preview Modal)，支持预览后下载。
    - 验证了所有布局模式下的导出尺寸正确性。

- **2026-02-03**: 完成了右侧属性面板重构 (Task-702)。
    - **组件抽取**: 将属性面板逻辑抽取为独立组件 `PropertiesPanel`，改善了 `Layout` 的代码结构。
    - **凭单设置**: 实现了完整的凭单设置表单，支持直接在侧边栏编辑标题、日期、报销人、部门及摘要，并显示实时的总金额。
    - **可见性开关**: 添加了 "显示凭单" 开关，允许用户隐藏凭单头部。
    - **动态布局**: 更新了网格计算引擎，当凭单隐藏时，第一页自动移除顶部偏移，充分利用空间。
    - **UI 组件**: 手动实现了 `Switch` 和 `Separator` 组件以支持新的面板 UI。
    - **稳定性修复**: 修复了属性面板在 Store 数据初始化时的崩溃问题，增加了空值保护和语法修正。
    - **紧急修复 (发票模式)**: 修复了切换到发票模式时的白屏崩溃问题 (React Hook Rule Violation)，确保了模式切换的稳定性。
    - **可见性逻辑**: 调整了 "凭单设置" 菜单的可见性逻辑，使其在发票模式下也默认显示，便于全局数据的统一管理。
    - **可编辑总额**: 实现了 "总金额" 的可编辑功能。用户手动修改金额后，会自动覆盖计算值，并提供 "重置" 按钮恢复自动计算。
    - **UI 润色**: 统一了属性面板中 "摘要" 和 "总金额" 的重置按钮样式，使用蓝色 "重置" 按钮替代了原有的文本链接，与画布上的样式保持一致。
    - **画布交互**: 实现了凭单画布上 "金额" 栏的直接编辑功能，并添加了与 "用途摘要" 一致的 "重置" 按钮，提升了操作的便捷性和统一性。
    - **视觉修复**: 增加了凭单金额列的宽度 (从 w-32 到 w-40)，解决了数字较长时最后一位显示不全的问题。
    - **输入润色**: 微调了 "报销人" 和 "部门/项目" 输入框的下划线长度 (宽度增加)，并将 "部门/项目" 栏整体向右移动 (右对齐)，满足特定视觉需求。
    - **面板布局**: 将属性面板 (凭单设置) 中的 "报销人" 和 "部门/项目" 输入框改为垂直排列，优化了侧边栏的空间利用和视觉层级。
    - **本地化**: 将 "Workspace" 页眉及属性面板 (Properties Panel) 中的所有英文标签翻译为中文，实现了界面的全中文显示。
    - **PDF 模态框**: 将导出预览 (Export Preview) 弹窗中的 "Cancel" 和 "Download PDF" 按钮翻译为 "取消" 和 "下载 PDF"，保持语言一致性。
    - **清空功能**: 将原生的 `confirm` 对话框替换为 `shadcn/ui` 的 `AlertDialog` 用于 "清空" 操作。提升了用户体验和可靠性。
    - **Canvas 显示**: 将 Canvas Item 上的硬编码 "RECEIPT" 标签更改为显示实际文件名（例如 "Invoice_001.pdf"），并对长文件名进行了截断处理。
    - **上传逻辑**: 在 `UploadZone` 中实现了重复文件检测。尝试上传已存在的文件现在会触发 `AlertDialog` 警告并跳过重复文件。修复了一个由于闭包状态陈旧导致检查失败的 Bug。
    - **UTF-8 支持**: 更新了重复文件检测验证逻辑，使用 `normalize('NFC')`。这确保了包含特殊字符（如中文）的文件名即使字符串编码引用略有不同，也能正确识别为重复项。
    - **凭单逻辑**: 更新了 `useInvoiceStore` 中的 `clearAllItems`，在清空工作区时重新生成 `voucherNo`（基于时间戳）。这确保了凭单 ID 在下次使用时被刷新。

## 最近更新

- **2026-02-03 (Late)**: 完成了打印与清空功能 (Task-700)。
  - **打印**: 实现了 `usePrint` Hook，利用隐藏 iframe 调用浏览器打印，复用高清 PDF 导出逻辑。
  - **清空**: 实现了全局清空功能，保留凭单头部信息（报销人、日期），需二次确认。
  - **布局修复**: 微调了凭单编号 (Voucher No) 的 CSS padding，解决了与下划线重叠的视觉问题。
- **2026-02-03 (鲁棒性)**: 完成了去重与逻辑增强 (Task-703)。
  - **上传**: 实现了基于 UTF-8 归一化的文件名去重，支持 PDF 页面检测，并添加了友好的 Alert 提示。
  - **状态**: 修复了清空操作后凭单号不更新的问题 (`generateVoucherNo`)。
  - **UI**: Canvas 卡片现在显示真实文件名。
- **2026-02-03 (Early)**: 完成了导出与打印优化 (Task-603)，修复了布局方向与裁剪问题，新增了 PDF 预览。
  - **紧急修复**: 解决了 PDF 导出时的渲染问题 (Task-Fix-Rendering)，通过 "Clone & Replace" 策略修复了凭单和文件项 (Amount/Usage) 输入框内容的显示异常，确保导出结果清晰准确。
  - **UI 优化**: 重构了 `FileItem` 组件 (Task-UI-Refine)，实现了标签与输入框同行显示，移除了备注栏，并将 Header 改为悬停显示，最大化图片展示空间。
  - **凭单布局精修**:
    - 隐藏了导出时的“重置”按钮。
    - 优化了表格垂直间距和头部对齐。
    - 确保了签字线下划线在导出时可见。
- **2026-02-03 (Bug修复)**:
  - **Page Navigator**: 实现了基于 ID 的滚动跟踪 (`intersectionObserver`)，修复了页面指示器更新问题。
  - **Build**: 修复了所有 TypeScript 构建错误和 Layout 语法问题。
  - **Refinement**: 将页面导航器移动到页眉，以获得更好的可访问性。
- **2026-02-02**: 完成了 Task-600，实现了多工作区的数据模型基础与全局汇总逻辑。正在进行侧边栏 UI 重构。
- **2026-02-02**: 完成了 Invoice Mode 的核心开发与验证，支持了纯报销单模式下的多种布局策略。
- **2026-01-30**：确认了网格布局的自动填坑 (Dense Packing) 策略。初始化了文档。

### 2026-02-04
- [x] **Task-400: 属性面板交互** - 实现了项目选择、调整大小和上下文属性面板。通过单元测试验证。
  - 更新了 `FileItem` 以支持可视化的选中状态。
  - 启用了 `PropertiesPanel` 中的上下文渲染（凭单与文件设置）。
  - 实现了项目调整大小 (`resizeItem` action) 和布局更新 (`calculateLayout`)。
  - 使用 Vitest 添加了布局引擎和 Store 逻辑的单元测试。
  - **修复严重 Bug**: 修复了文件上传时因未选中项目尺寸而导致布局引擎进入无限循环从而导致应用冻结/崩溃的问题。添加了严格的尺寸限制和安全中断。

### 2026-02-04 (Part 2)
- **Task-401: 尺寸优化**
  - 将默认文件尺寸从 2x2 更新为 2x3（垂直标准）。
  - 更新了 PropertiesPanel UI：移除了 1x1/4x4，添加了 2x3 选项。
  - 通过更新后的单元测试进行了验证。

- **Task-402: 属性面板 UI 润色**
  - 通过将面板宽度增加到 320px 并添加 `shrink-0` 修复了右侧内容截断的问题。
  - 为选中的尺寸按钮添加了可视化的激活状态（高亮）。

- **Task-403: 发票模式逻辑与 UI 修复**
  - **布局**: 强制“报销发票”模式使用固定尺寸。
      - 网格布局: 2x2。
      - 垂直布局: 4x3 (上下分栏)。
  - **属性面板**: 
      - 宽度增加到 **350px** 以防止截断。
      - 在“报销发票”模式下自动 **隐藏尺寸控制**（固定尺寸）。

- **Task-404: 属性面板与付款凭单逻辑**
  - **首页检测**: 在 `PropertiesPanel` 中实现了检测选中项目是否在第 1 页的逻辑。
  - **尺寸限制**: 
      - 如果 `appMode === 'payment'` 且 `isVoucherVisible` 且 `isFirstPage`:
      - **隐藏**: 2x3 和 4x3 选项（避免浪费凭单下方的空间）。
      - **允许**: 2x2, 2x4, 4x2 选项。
  - **交互**: 确认点击背景可取消选中项目。

- **Task-405: 智能默认尺寸**
  - **上传逻辑**: 
      - **横向**: 默认为 4x3（标准）或 4x2（第 1 页 + 凭单）。
      - **纵向**: 默认为 2x3（标准）或 2x4（第 1 页 + 凭单）。
  - **选项逻辑**: 限制 `2x4` 选项仅在带有凭单的第 1 页可见。

- **Task-401 (重访): 图片编辑器**
  - **核心组件**: 使用 `react-cropper` 实现了 `ImageEditorModal`。
  - **集成**: 在 `PropertiesPanel` 中添加了“裁剪 / 编辑”按钮。
  - **存储**: 直接更新项目图片数据 (`fileData`) 并在保存后重置旋转角度为 0。
  - **依赖**: 集成了 `cropperjs` (v1.6.2) 和 `react-cropper`。
  - **验证**: 通过手动构建和 lint 修复进行了验证。

- **Task-500: UI 细节打磨**
  - **空状态**: 为 `GridCanvas` 添加了 `EmptyState` 组件（当未上传项目时）。
  - **加载状态**: 添加了全局 `LoadingOverlay`，在 PDF 导出期间触发。
  - **Tab 顺序**: 优化了键盘导航流程 (`金额` -> `用途` -> `备注`) 并在 `FileItem` 中添加了 `备注` 输入字段。
  - **稳定性**: 验证了完整的生产构建并解决了 TypeScript/CSS 警告。

- **Bugfix-501: 导出/打印图片拉伸**
  - **问题**: `html2canvas` 不支持 `object-fit: contain`，导致图片拉伸至 `100%` 宽/高。
  - **修复**: 在 `FileItem.tsx` 中将 `w-full h-full` 替换为 `max-w-full max-h-full w-auto h-auto`。
  - **验证**: 通过生产构建验证。

- **Bugfix-502: 导出/打印灰色背景**
  - **问题**: 文件项具有 `bg-slate-100` 背景以增加对比度，这在 PDF 导出中看起来像“边框”或“多余的灰色”。
  - **修复**: 为容器添加了 `pdf-export-bg-white` 类，并在 `useExportPdf` 中实现了导出捕获期间强制背景为 `#ffffff` 的逻辑。
  - **验证**: 通过生产构建验证。

- **Bugfix-503: 导出/打印文件项边框**
  - **问题**: 文件项具有默认的浅灰色边框 (`border-slate-200`)，在 PDF 导出中可见。
  - **修复**: 为外部容器添加了 `pdf-export-border-none` 类，并在 `useExportPdf` 中实现了导出捕获期间强制 `border: none` 和 `box-shadow: none` 的逻辑。
  - **验证**: 通过生产构建验证。

- **2026-02-04 (Refactoring)**: 完成了全局重构与代码规范化 (Task-800)。
  - **File Headers**: 为所有源文件 (`src/**/*`) 添加了标准统一的文件头注释 (File, Description, License)。
  - **Localization**: 将代码中的所有注释和 UI 文本全面中文化，方便维护。
  - **Logic**: 移除了未使用的死代码 (`TestComponents.tsx`)。
  - **Stability**: 验证了重构后的构建稳定性，确保无功能回退。

- **2026-02-04 (Documentation)**: (Task-900)。
  - **Translation**: 将所有项目文档 (`specs.md`, `tech-stack.md`, `architecture.md`, `progress.md`, `todo.md`) 翻译为中文。
  - **Formatting**: 修正了部分 markdownlint 格式警告。
  - **Consistency**: 统一了文档结构与术语（如 "Workspace", "Layout Engine"）。

- **2026-02-04 (UI Refinement)**: 界面细节优化。
  - **Cleanup**: 移除了 Header 中冗余的侧边栏展开按钮，优化了界面整洁度。
  - **Animation**: 实现了 Logo 和 Github 图标的 Hover 缩放/旋转动效，以及 "EasyInvoice" 标题的流光渐变效果 (Gradient Text)。

